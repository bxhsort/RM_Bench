{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "Node 原有示例",
      "type": "node",
      "request": "launch",
      "program": "${file}",
      "skipFiles": ["<node_internals>/**"]
    },

    {
      // 多卡 FSDP 训练（与 .sh 基本一致）
      "name": "RL Train (Accelerate FSDP Multi-GPU)",
      "type": "python",
      "request": "launch",
      "module": "accelerate.commands.launch",
      "justMyCode": false,
      "python": "/opt/conda/envs/editscore/bin/python",
      "console": "integratedTerminal",
      "env": {
        "CUDA_VISIBLE_DEVICES": "1,2,3,4",
        "RANK": "0",
        "WORLD_SIZE": "1",
        "MASTER_ADDR": "127.0.0.1",
        "MASTER_PORT": "29500",
        "NCCL_DEBUG": "INFO",
        "NCCL_ASYNC_ERROR_HANDLING": "1",
        "PYTHONUNBUFFERED": "1"
      },
      "args": [
        "--machine_rank=0",
        "--main_process_ip=127.0.0.1",
        "--main_process_port=29500",
        "--num_machines=1",
        "--num_processes=4",
        "--use_fsdp",
        "--fsdp_offload_params", "false",
        "--fsdp_sharding_strategy", "HYBRID_SHARD",
        "--fsdp_auto_wrap_policy", "TRANSFORMER_BASED_WRAP",
        "--fsdp_transformer_layer_cls_to_wrap", "OmniGen2TransformerBlock",
        "--fsdp_state_dict_type", "SHARDED_STATE_DICT",
        "--fsdp_forward_prefetch", "false",
        "--fsdp_use_orig_params", "True",
        "--fsdp_cpu_ram_efficient_loading", "false",
        "--fsdp_sync_module_states", "True",
        "train.py",
        "--config",
        "options/omnigen2_edit_rl_single_machine_editscore7b.yml"
      ]
    },

    {
      // 单 GPU 简化调试（便于逐步排查 OOM / NCCL）
      "name": "RL Train (Single GPU Debug, no FSDP)",
      "type": "python",
      "request": "launch",
      "program": "${workspaceFolder}/examples/OmniGen2-RL/train.py",
      "console": "integratedTerminal",
      "justMyCode": false,
      "env": {
        "CUDA_VISIBLE_DEVICES": "0",
        "WORLD_SIZE": "1",
        "RANK": "0",
        "MASTER_ADDR": "127.0.0.1",
        "MASTER_PORT": "29500",
        "PYTHONUNBUFFERED": "1"
      },
      "args": [
        "--config",
        "options/omnigen2_edit_rl_single_machine_editscore7b.yml"
      ]
    },

    {
      // 仅脚本逻辑（不进入 accelerate），适合快速验证配置解析
      "name": "Config Parse Only",
      "type": "python",
      "request": "launch",
      "program": "${workspaceFolder}/examples/OmniGen2-RL/train.py",
      "console": "integratedTerminal",
      "justMyCode": true,
      "env": {
        "DRY_RUN": "1"
      },
      "args": [
        "--config",
        "options/omnigen2_edit_rl_single_machine_editscore7b.yml"
      ]
    }
  ]
}